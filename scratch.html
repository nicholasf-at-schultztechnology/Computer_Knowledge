
a = Split(Session("Selections"), ", ")
Session("Selections") = ""

If UBound(a) = -1 Then
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<b><font color="red" face="tahoma" size=2>No carriers were selected.  Select at least one carrier and retry.</font></b>';
document.all.statusimg.src='../../../images/scan-stopped.gif';
document.all.headertitle.innerText = 'Process complete.';
document.all.headerfooter.innerText = 'Please click the Close button to dismiss this dialog.';
document.all.btnClose.disabled = false;
window.dialogArguments.parent.middle_right.btnCloseManifests.disabled = false;
window.dialogArguments.parent.middle_left.location.reload();
window.dialogArguments.parent.middle_right.location.reload();
blStillClosing = false;
</script>
</body>
</html>
<%
Close(objConn)
Response.End
End If

objConn.Execute("CALL APP.INIT_SESSION()")
log.log "Entering Close"

For i = 0 to UBound(a) - 1
b = Split(a(i),",")

Dim dtManifestDate, strManifestDate

dtManifestDate = CDate(b(1))
strManifestDate = Year(dtManifestDate) & "-" & Right("0" & Month(dtManifestDate),2) & "-" & Right("0" & Day(dtManifestDate),2)

strCarrier = b(0)
strVolume = b(2)

%>
<script language="javascript">

document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<B><font size="1" color="#333333" face="Tahoma">Closing <%=strCarrier%> for <%=strManifestDate%>...</font></B><BR>';

</script>
<%
Response.Flush

If CInt(strVolume) = 0 Then
objConn.Execute("DELETE FROM APP.OPEN_MANIFESTS WHERE CARRIER_CODE = '" & strCarrier & "' AND MANIFEST = '" & strManifestDate & "'")
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="#006600" face="Tahoma"><B>Manifest closed successfully.</B></font><BR><BR>';
</script>
<%
Response.Flush

Else
If Mid(Session("EventAction"), 16, 1) ="Y" Then
%><script language="javascript">
parent.before.navigate('integration/before_closing_carrier/default.asp?rid=' + Math.floor(Math.random()*3333));
</script><%
Response.Flush
End If
objConn.Execute "DELETE FROM SESSION.ERRORS"

Set Cmd = Server.CreateObject("ADODB.Command")
log.log "Closing carrier:" & strCarrier & " date:" & strManifestDate
With Cmd
.CommandText = "CALL APP.CLOSE_CARRIER('" & strCarrier & "', '" & strManifestDate & "')"
.CommandTimeout=3600
.ActiveConnection = objConn
End With

On Error Resume Next
Cmd.Execute

Set rsCount = objConn.Execute("SELECT COUNT(*) FROM SESSION.ERRORS")
If rsCount.Fields(0).Value > 0 Then
strErrors = ""
Set rsError = objConn.Execute("SELECT NOTES FROM SESSION.ERRORS")

Do Until rsError.EOF
if rsError.Fields(0).Value <> "" then
strErrors = strErrors & rsError.Fields(0).Value & "<BR><BR>"
end if
rsError.MoveNext
Loop

Set rsError = Nothing
On Error Resume Next
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1"color="red" face="Tahoma"><B><%=strErrors%></B></font>'
</script>
<%
Response.Flush
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML + '<font size="1" color="darkred" face="Tahoma"><B>Error closing manifest.  Please print this error for future reference.</B></font><BR>'
</script>
<%
Response.Flush
%>
<script language="javascript" defer>
document.all.statusimg.src='../../../images/scan-stopped.gif';
document.all.headertitle.innerText = 'Process incomplete.';
document.all.headerfooter.innerText = 'An error has occured while closing carrier.  Click the Details button for more information or click the Close button to dismiss this dialog.';
document.all.btnClose.disabled = false;

blStillClosing = false;
</script>
</body>
</html>
<%
Close(objConn)
Response.End
End If

On Error Resume Next
strErrors = ""
Set rsError = objConn.Execute("SELECT STATUS_CODE, STATUS_DESCRIPTION FROM APP.CARRIER_EDI WHERE ARCHIVE_ID = (SELECT ARCHIVE_ID FROM ARCHIVE.SHIPMENTS WHERE CARRIER_CODE = '" & strCarrier & "' ORDER BY ID DESC FETCH FIRST ROW ONLY)")
Set rsEDILogic = objConn.Execute("SELECT * FROM APP.CARRIERS WHERE CODE = '" & strCarrier & "' AND CARRIER_EDI_LOGIC_CODE <> 'NONE'")
log.log "Error " & rsError.Fields(0).Value
If Not rsError.EOF Then
If rsError.Fields(0).Value <> "0" then
strErrors = "Status code " & rsError.Fields(0).Value & ": " & rsError.Fields(1).Value & "<BR><BR>"
log.log "Errors " & strErrors
End if
Else
Set rsTemplate = objConn.Execute("SELECT TEMPLATE_CODE FROM APP.CARRIERS WHERE CODE = '" & strCarrier & "'")

log.log "Template Code for Carrier " & rsTemplate

If rsTemplate.Fields(0).Value = "FDX" then
strErrors = "Fedex Transaction Error "
ElseIf rsTemplate.Fields(0).Value = "USPS" Then
Set rsUSPS = objConn.Execute("SELECT * FROM ARCHIVE.SHIPMENTS S INNER JOIN ARCHIVE.PACKAGES P ON S.ID = P.SHIPMENT_ID INNER JOIN ARCHIVE.SPECIAL_SERVICES SP ON SP.PACKAGE_ID = P.ID WHERE S.ARCHIVE_ID = (SELECT ARCHIVE_ID FROM ARCHIVE.SHIPMENTS WHERE CARRIER_CODE = '" & strCarrier & "' ORDER BY ID DESC FETCH FIRST ROW ONLY) AND (SP.SPECIAL_SERVICE_CODE = 'DC' OR SP.SPECIAL_SERVICE_CODE = 'SR')")
If Not rsUSPS.EOF Then
strErrors = "USPS EDI file failed to generate."
End If

rsUSPS = Nothing
Else
If Not rsEDILogic.EOF Then
strErrors = "No EDI file was generated."
End If
End If

rsTemplate=Nothing
End If
Set rsError = Nothing

If strErrors <> "" and LCase(Mid(strErrors,1,17)) <> "status code 2021:" Then
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1"color="red" face="Tahoma"><B><%=strErrors%></B></font><br />'
</script>
<%
Response.Flush
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML + '<font size="1" color="darkred" face="Tahoma"><B>Error closing manifest.  Please print this error for future reference.</B></font><BR>'
</script>
<%
Response.Flush
%>
<script language="javascript" defer>
document.all.statusimg.src='../../../images/scan-stopped.gif';
document.all.headertitle.innerText = 'Process incomplete.';
document.all.headerfooter.innerText = 'An error has occured while closing carrier.  Click the Details button for more information or click the Close button to dismiss this dialog.';
document.all.btnClose.disabled = false;

blStillClosing = false;
</script>
</body>
</html>
<%
Close(objConn)
Response.End
Else
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="#006600" face="Tahoma"><B>Manifest closed successfully.</B></font><BR>'
</script>
<%
Response.Flush
If Mid(Session("EventAction"), 16, 1) ="Y" Then
%>
<script language="javascript">
parent.after.navigate('integration/after_closing_carrier/default.asp?rid=' + Math.floor(Math.random()*3333));
</script>
<%
Response.Flush
End If
End If

On Error Goto 0

'Loads the ARCHIVE_ID
strSQL = "SELECT ARCHIVE_ID FROM ARCHIVE.SHIPMENTS WHERE CARRIER_CODE = '" & strCarrier & "' ORDER BY ARCHIVE_ID DESC FETCH FIRST ROW ONLY"

log.log "Load Archive ID: " & strSQL

Set rs = objConn.Execute(strSQL)
If Not rs.EOF Then
lngArchiveID = rs.Fields(0).Value
log.log "Archive ID: " & lngArchiveID
Set rs = nothing
log.log "Before SOManifest"
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<b><font size="1" color="#333333" face="Tahoma">Exporting SO <%=strCarrier%> EDI manifested file ...</font></b><BR>';
</script>
<%
log.log "CREATE SO FILES"
log.log "CALL FEDEX.CUSTOMIZATION_CARRIER_EDI(" & lngArchiveID & ", 'D:\Logicor\sofiles\')"
objConn.Execute("CALL FEDEX.CUSTOMIZATION_CARRIER_EDI(" & lngArchiveID & ", 'D:\Logicor\sofiles\')")

%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<b><font size="1" color="#006600" face="Tahoma">Completed SO <%=strCarrier%> EDI manifested file ...</font></b><BR>';
</script>
<%

Else
lngArchiveID = 0

%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<b><font size="1" color="#006600" face="Tahoma">Error Exporting SO <%=strCarrier%> EDI manifested file ...</font></b><BR>';
</script>
<%

Set rs = nothing
End If
log.log "After SOManifest"
'Loads the ARCHIVE_ID
strSQL = "SELECT ARCHIVE_ID FROM ARCHIVE.SHIPMENTS WHERE CARRIER_CODE = '" & strCarrier & "' ORDER BY ID DESC FETCH FIRST ROW ONLY"
Set rs = objConn.Execute(strSQL)
If Not rs.EOF Then
lngArchiveID = rs.Fields(0).Value
Else
lngArchiveID = 0
End If
Set rs = nothing
log.log "Archive ID "& lngArchiveID
strSQL = "SELECT TEMPLATE_CODE FROM APP.CARRIERS WHERE CODE = '" & strCarrier & "'"
Set rs = objConn.Execute(strSQL)
If Not rs.EOF Then
strTemplateCode = rs.Fields(0).Value
Else
strTemplateCode = ""
End If
Set rs = nothing
log.log "Carrier Template Code " & strTemplateCode
If strTemplateCode = "USPS" Then
' Sunwind 08082006
' Load USPS services
strSQL = "SELECT DISTINCT SERVICE_CODE FROM ARCHIVE.PACKAGES WHERE SHIPMENT_ID IN ( SELECT ID FROM ARCHIVE.SHIPMENTS WHERE ARCHIVE_ID=" & lngArchiveID & ")"
Set rsReports = objConn.Execute(strSQL)
strUSPSReports = "USPS_ItemizedManifest.rpt;USPS_Form3877Facsimile.rpt;USPS_3152.rpt;USPS_ItemizedSummary.rpt;USPS_Express_3152E.rpt;USPS_Express_VerificationManifest.rpt"
Do Until rsReports.EOF
Select Case rsReports.Fields("SERVICE_CODE")
Case "FCM"
strUSPSReports = ";" & strUSPSReports & "USPS_FirstClass.rpt"
Case "FCMP"
strUSPSReports = ";" & strUSPSReports & "USPS_FirstClass.rpt"
Case "PM"
strUSPSReports = ";" & strUSPSReports & "USPS_Priority.rpt"
Case "PML"
strUSPSReports = ";" & strUSPSReports & "USPS_Priority.rpt"
Case "PMB"
strUSPSReports = ";" & strUSPSReports & "USPS_Priority.rpt"
Case "MM"
strUSPSReports = ";" & strUSPSReports & "USPS_Media.rpt"
Case "PS"
strUSPSReports = ";" & strUSPSReports & "USPS_Parcelselect.rpt"
Case "PP"
strUSPSReports = ";" & strUSPSReports & "USPS_Parcelpost.rpt"
End Select
rsReports.MoveNext
Loop
Set rsReports = nothing
Elseif strTemplateCode = "STANDARD" Then
'''''''''''''''''''''''''''''''''''''''''''''''''''
'''SUNWIND

Set rsCloseCarrierLogic = objConn.Execute("SELECT CLOSE_CARRIER_LOGIC_CODE FROM APP.CARRIERS WHERE CODE ='" & strCarrier & "'")
log.log "Carrier Close Logic " & rsCloseCarrierLogic.Fields(0).Value
If (not rsCloseCarrierLogic.EOF) Then

If (rsCloseCarrierLogic.fields("CLOSE_CARRIER_LOGIC_CODE").Value = "CAL") Then

'On Error Resume Next
Set Session("objReportEngine") = Server.CreateObject("ReportEngine.CR")
Set ReportEngine = Server.CreateObject("ReportEngine.CR")
ReportEngine.DSN = Application("dbDSN")
ReportEngine.Database = Application("dbName")
ReportEngine.Login = Application("dbLogin")
ReportEngine.Password = Application("dbPassword")
ReportEngine.ExportFile = Request.ServerVariables("APPL_PHYSICAL_PATH") & "main\manifests\close\results\archive\CAL_" & lngArchiveID & ".pdf"
ReportEngine.ReportFile = Request.ServerVariables("APPL_PHYSICAL_PATH") &  "main\reports\CAL_ShippingManifest.rpt"
ReportEngine.Parameters = "ARCHIVE_ID"
ReportEngine.ParameterValues = CStr(lngArchiveID)
ReportEngine.Print

Set FSO = CreateObject("Scripting.FileSystemObject")
Set objFile = FSO.GetFile(Request.ServerVariables("APPL_PHYSICAL_PATH") & "main\manifests\close\results\archive\CAL_" & lngArchiveID & ".pdf")
If objFile.Size > 2000 Then
If Err.Number <> 0 Then
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="red" face="Tahoma"><B>[<%=Err.Source%>][<%=Err.Number%>][<%=Err.Description%>]</B></font><BR>';
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="darkred" face="Tahoma"><B>Error printing manifest.  This manifest can be reprinted from the Reprint area of the Manifests menu.</B></font><BR><BR>';
</script>
<%
Response.Flush
Else

%>
<script language="javascript">

try
{
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<b><font size="1" color="#333333" face="Tahoma">Printing <%=strCarrier%> - <%=rsManifests.Fields("REPORT_DESCRIPTION").Value%>...</font></b><BR>';
document.all.PfastshipEliteTools.PrintURL("https://<%=Request.ServerVariables("HTTP_HOST")%>/main/manifests/close/results/archive/CAL_<%=lngArchiveID%>.pdf");
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<a href="archive/CAL_<%=lngArchiveID%>.pdf" target="_new"><B><font size="1" color="blue" face="Tahoma" style="cursor=hand;">Click here to view this manifest</B></font></a><BR><BR>';
}
catch(e)
{
}
</script>
<%
Response.Flush

End If
Else
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1"color="darkred" face="Tahoma"><B>Report empty, nothing will print for this report.</B></font><BR><BR>';
</script>
<%
Response.Flush
End If
Response.Flush

On Error Goto 0


End If


End If

''''''''''''''''''''''''''''''''''''''''''''''''

If Not rsEDILogic.EOF Then
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<b><font size="1" color="#006600" face="Tahoma">Exporting <%=strCarrier%> EDI manifested file ...</font></b><BR>';
</script>
<%
End If
'load carrier parameters
strSQL = "SELECT CEP.DESCRIPTION, COALESCE(CEP.VALUE, '') AS VALUE " & _
" FROM APP.CARRIER_EDI_LOGIC_PARAMETERS CEP INNER JOIN APP.CARRIERS C ON C.CODE = CEP.CARRIER_CODE AND C.CARRIER_EDI_LOGIC_CODE = CEP.CARRIER_EDI_LOGIC_CODE " & _
" WHERE C.CODE = '" & strCarrier & "' AND C.CARRIER_EDI_LOGIC_CODE = 'SEND_EDI' AND CEP.DESCRIPTION IN ('EDI working directory', 'EDI format file')"
Set rs = objConn.Execute(strSQL)
Do Until Rs.EOF
If UCase(rs.Fields(0).Value) = "EDI WORKING DIRECTORY" Then
strEDIdirectory = rs.Fields(1).Value
strEDIdirectory = Replace(strEDIdirectory, "/", "\")
If Right(trim(strEDIdirectory), 1) <> "\" Then
strEDIdirectory = strEDIdirectory & "\"
End If
End If
log.log "EDI Directory " & strEDIdirectory
If UCase(rs.Fields(0).Value) = "EDI FORMAT FILE" Then
strEDIformatfile = rs.Fields(1).Value
log. log "EDI File Format "& strEDIformatfile
End If

rs.MoveNext
Loop
Set rs = Nothing
Response.Flush
If trim(strEDIformatfile) <> "" Then
'Export the EDI file
strReportName = Split(strEDIformatfile, ".")(0)

If Not IsObject(Session("objReportEngine")) Then
Set Session("objReportEngine") = Server.CreateObject("ReportEngine.CR")
End If

'On Error Resume Next
Set ReportEngine = Session("objReportEngine")
ReportEngine.DSN = Application("dbDSN")
ReportEngine.Database = Application("dbName")
ReportEngine.Login = Application("dbLogin")
ReportEngine.Password = Application("dbPassword")
ReportEngine.ExportType = "CSV"
strReportName = strEDIdirectory & strCarrier & "\" & strReportName & "_" & lngArchiveID & ".csv"
ReportEngine.ExportFile = strReportName
ReportEngine.ReportFile = Request.ServerVariables("APPL_PHYSICAL_PATH") & "main\reports\" & strEDIformatfile
ReportEngine.Parameters = "ARCHIVE_ID"
ReportEngine.ParameterValues = lngArchiveID
ReportEngine.Print
log.log "1DSN " & ReportEngine.DSN
log.log "1Database " & ReportEngine.Database
log.log "1Login " & ReportEngine.Login
log.log "1Password " & ReportEngine.Password
log.log "1ExportType " & ReportEngine.ExportType
log.log "1ReportName  " & strReportName
log.log "1ExportFile " & ReportEngine.ExportFile
log.log "1ReportFile " & ReportEngine.ReportFile
log.log "1Parameters " & ReportEngine.Parameters
log.log "1ParameterValues " & ReportEngine.ParameterValues
If Err.Number = 0 Then
strErrCode = "999"
strErrMes = "The manifested file is created"
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="#006600" face="Tahoma"><B>Carrier manifest file exported successfully.</B></font><BR>'
</script>
<%
Else
strErrCode = "998"
strErrMes = Err.Message
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="darkred" face="Tahoma"><B>Error exporting carrier manifest file.  Please print this error for future reference.</B></font><BR>'
</script>
<%
End If

Response.Flush
'insert the records to CARRIER_EDI
strSQL = "DELETE FROM APP.CARRIER_EDI WHERE CODE = '" & lngArchiveID & "'"
objConn.Execute(strSQL)

strSQL = "INSERT INTO APP.CARRIER_EDI (CODE, ARCHIVE_ID, DESCRIPTION, FILE_PATH, FILE_SIZE, STATUS_DESCRIPTION, STATUS_CODE) " & _
" VALUES ('" &  lngArchiveID & "', " & lngArchiveID & ", '" & strCarrier & " EDI manifested file" & "','" & strReportName & "', 0, '" & strErrMes & "','" & strErrCode & "')"
objConn.Execute(strSQL)

On Error Goto 0

'Send EDI file
objConn.Execute "DELETE FROM SESSION.ERRORS"

Set Cmd = Server.CreateObject("ADODB.Command")

With Cmd
.CommandText = "CALL APP.CARRIER_EDI(" & lngArchiveID & ")"
.ActiveConnection = objConn
End With

'On Error Resume Next
Cmd.Execute
If Err.Number <> 0 Then
Set Rs = objConn.Execute("SELECT * FROM SESSION.ERRORS")
strErrors = ""
Do Until Rs.EOF
strErrors = strErrors & Replace(Rs.Fields("Details").Value, vbCrLf, "<BR>") & "<BR>"
Rs.MoveNext
Loop

%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1"color="red" face="Tahoma"><B><%=strErrors%></B></font><BR>'
</script>
<%
Response.Flush
Set Rs = Nothing
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="darkred" face="Tahoma"><B>Error sending carrier manifest file.  Please print this error for future reference.</B></font><BR>'
</script>
<%
Response.Flush
Else
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="#006600" face="Tahoma"><B>Carrier manifest file sent successfully.</B></font><BR>'
</script>
<%
Response.Flush
End If
End If
End If

On Error Goto 0

'Loads the reports
strSQL = "SELECT " & _
"RP1.VALUE AS REPORT_FILE, " & _
"RP2.VALUE AS PRINT, " & _
"RP3.VALUE AS CARRIER_CODE, " & _
"R.CODE AS REPORT_CODE, " & _
"R.DESCRIPTION AS REPORT_DESCRIPTION " & _
"FROM " & _
"APP.REPORTS AS R, " & _
"APP.REPORT_PARAMETERS AS RP1, " & _
"APP.REPORT_PARAMETERS AS RP2, " & _
"APP.REPORT_PARAMETERS AS RP3 " & _
"WHERE " & _
"R.TEMPLATE_CODE = 'CARRIER_REPORT' AND " & _
"RP1.REPORT_CODE = R.CODE AND " & _
"(RP1.DESCRIPTION = 'File name' OR RP1.DESCRIPTION = 'Stored procedure') AND " & _
"RP2.REPORT_CODE = R.CODE AND " & _
"RP2.DESCRIPTION = 'Print after executing Close Carrier Logic' AND " & _
"RP3.REPORT_CODE = R.CODE AND " & _
"RP3.DESCRIPTION = 'Carrier code' AND " & _
"RP3.VALUE = '" & strCarrier & "' AND RP2.VALUE = '1' " & _
"ORDER BY REPORT_FILE"

Set rsManifests = objConn.Execute(strSQL)
Do Until rsManifests.EOF
log.log "Manifest REPORT FILE " & rsManifests.Fields("REPORT_FILE").Value
log.log "Manifest PRINT " & rsManifests.Fields("PRINT").Value
log.log "Manifest CARRIER CODE " & rsManifests.Fields("CARRIER_CODE").Value
log.log "Manifest REPORT CODE " & rsManifests.Fields("REPORT_CODE").Value
log.log "Manifest Report Description " & rsManifests.Fields("REPORT_DESCRIPTION").Value


%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<b><font size="1" color="#333333" face="Tahoma">Printing <%=strCarrier%> - <%=rsManifests.Fields("REPORT_DESCRIPTION").Value%>...</font></b><BR>';
</script>
<%
Response.Flush()
'Use "regasm /tlb reportengine.dll" and "regasm /codebase reportengine.dll" to register the DotNet DLL
If rsManifests.Fields("REPORT_DESCRIPTION").Value = "Pickup Summary Barcode Label" Then

'On Error Resume Next

objConn.Execute("CALL UPS.GET_LBL_SUMMARY_BARCODE(" & lngArchiveID & ")")
If Err.Number <> 0 Then
blnCancel = True
End If
Set rsLabel = objConn.Execute("SELECT * FROM SESSION.LABEL_OUTPUT")

On Error Goto 0

strLabel = ""
Do Until rsLabel.EOF
strLabel = strLabel & rsLabel.Fields(0).Value
rsLabel.MoveNext
Loop

If strLabel = "" or blnCancel Then
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="red" face="Tahoma"><B>[<%=Err.Source%>][<%=Err.Number%>][<%=Err.Description%>]</B></font><BR>';
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="darkred" face="Tahoma"><B>Error printing manifest.  This manifest can be reprinted from the Reports area of the main menu.</B></font><BR><BR>';
</script>
<%
Response.Flush
Else
strLabel = Replace(Replace(Replace(Replace(Replace(strLabel,"\","\\"),"'","\'"),"""","\"""), CHR(10), "\n"), CHR(13), "")
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="darkgreen" face="Tahoma" style="cursor=hand;"><B>Report printed.</B></font><BR><BR>';
</script>
<%
Response.Flush
%>
<script language="javascript">
try
{
document.all.PfastshipEliteTools.PrintString("<%=CleanText(Session("DefaultWorkstationLabelPrinter"))%>", '<%=strLabel%>', 'Pickup Summary Barcode Label');
}
catch(e)
{
}
</script>
<%
Response.Flush
End If

On Error Goto 0
'Sunwind added for VICSBOL
ElseIf rsManifests.Fields("REPORT_DESCRIPTION").Value = "VICSBOL" Then
log.log "Entering BOL Section"

Set rsTrackingNumbers = objConn.Execute("SELECT MAX(TRACKING_NUMBER) as TRACKING_NUMBER FROM ARCHIVE.PACKAGES WHERE SHIPMENT_ID IN (SELECT ID FROM ARCHIVE.SHIPMENTS WHERE ARCHIVE_ID = " & lngArchiveID & " ) GROUP BY TRACKING_NUMBER")

log.log "Tracking Numbers " & rsTrackingNumbers.Fields(0).Value
On Error Goto 0
strTrackingNumber = ""
Do Until rsTrackingNumbers.EOF
strTrackingNumber = rsTrackingNumbers.Fields(0).Value
log.log "Tracking Number for BOL " & strTrackingNumber
On Error Resume Next
Set ReportEngine = Server.CreateObject("ReportEngine.CR")
Set Session("objReportEngine") = Server.CreateObject("ReportEngine.CR")
ReportEngine.DSN = Application("dbDSN")
ReportEngine.Database = Application("dbName")
ReportEngine.Login = Application("dbLogin")
ReportEngine.Password = Application("dbPassword")
ReportEngine.ExportFile = Request.ServerVariables("APPL_PHYSICAL_PATH") & "main\manifests\close\results\archive\" & rsManifests.Fields("REPORT_CODE").value & "_" & strTrackingNumber & ".pdf"
ReportEngine.ReportFile = Request.ServerVariables("APPL_PHYSICAL_PATH") &  "main\reports\" & rsManifests.Fields("REPORT_FILE").value
ReportEngine.Parameters = "TRACKING_NUMBER"
ReportEngine.ParameterValues = CStr("'" & strTrackingNumber & "'")
ReportEngine.Print
log.log "BOL_DSN " & ReportEngine.DSN
log.log "BOL_Database " & ReportEngine.Database
log.log "BOL_Login " & ReportEngine.Login
log.log "BOL_Password " & ReportEngine.Password
log.log "BOL_ReportName  " & strReportName
log.log "BOL_ExportFile " & ReportEngine.ExportFile
log.log "BOL_ReportFile " & ReportEngine.ReportFile
log.log "BOL_Parameters " & ReportEngine.Parameters
log.log "BOL_ParameterValues " & ReportEngine.ParameterValues

Set FSO = CreateObject("Scripting.FileSystemObject")
Set objFile = FSO.GetFile(Request.ServerVariables("APPL_PHYSICAL_PATH") & "main\manifests\close\results\archive\" & rsManifests.Fields("REPORT_CODE").value & "_" & strTrackingNumber & ".pdf")
If objFile.Size > 2000 Then
If Err.Number <> 0 Then
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="red" face="Tahoma"><B>[<%=Err.Source%>][<%=Err.Number%>][<%=Err.Description%>]</B></font><BR>';
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="darkred" face="Tahoma"><B>Error printing manifest.  This manifest can be reprinted from the Reprint area of the Manifests menu.</B></font><BR><BR>';
</script>
<%
Response.Flush
Else
%>
<script language="javascript">
//document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<a href="archive/<%=rsManifests.Fields("REPORT_CODE").value & intCounter%>.pdf" target="_new"><B><font size="1" color="blue" face="Tahoma" style="cursor=hand;">Click here to view this manifest</B></font></a><BR><BR>';
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<a href="archive/<%=rsManifests.Fields("REPORT_CODE").value & "_" & strTrackingNumber%>.pdf" target="_new"><B><font size="1" color="blue" face="Tahoma" style="cursor=hand;">Click here to view this manifest</B></font></a><BR><BR>';

try
{
//document.all.PfastshipEliteTools.PrintURL("http://<%=Request.ServerVariables("HTTP_HOST")%>/main/manifests/close/results/archive/<%=rsManifests.Fields("REPORT_CODE").value & intCounter%>.pdf");
document.all.PfastshipEliteTools.PrintURL("https://<%=Request.ServerVariables("HTTP_HOST")%>/main/manifests/close/results/archive/<%=rsManifests.Fields("REPORT_CODE").value & "_" & strTrackingNumber%>.pdf");
}
catch(e)
{
}
</script>
<%
Response.Flush
End If
Else
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1"color="darkred" face="Tahoma"><B>Report empty, nothing will print for this report.</B></font><BR><BR>';
</script>
<%
Response.Flush
End If
Response.Flush()

rsTrackingNumbers.MoveNext
intCounter = intCounter + 1
Loop
log.log "Leaving BOL Section"
Else

'On Error Resume Next
Set Session("objReportEngine") = Server.CreateObject("ReportEngine.CR")
Set ReportEngine = Server.CreateObject("ReportEngine.CR")
ReportEngine.DSN = Application("dbDSN")
ReportEngine.Database = Application("dbName")
ReportEngine.Login = Application("dbLogin")
ReportEngine.Password = Application("dbPassword")
ReportEngine.ExportFile = Request.ServerVariables("APPL_PHYSICAL_PATH") & "main\manifests\close\results\archive\" & rsManifests.Fields("REPORT_CODE").value & ".pdf"
ReportEngine.ReportFile = Request.ServerVariables("APPL_PHYSICAL_PATH") &  "main\reports\" & rsManifests.Fields("REPORT_FILE").value
ReportEngine.Parameters = "ARCHIVE_ID"
ReportEngine.ParameterValues = CStr(lngArchiveID)
ReportEngine.Print
log.log "2DSN " & ReportEngine.DSN
log.log "2Database " & ReportEngine.Database
log.log "2Login " & ReportEngine.Login
log.log "2Password " & ReportEngine.Password
log.log "2ReportName  " & strReportName
log.log "2ExportFile " & ReportEngine.ExportFile
log.log "2ReportFile " & ReportEngine.ReportFile
log.log "2Parameters " & ReportEngine.Parameters
log.log "2ParameterValues " & ReportEngine.ParameterValues

Set FSO = CreateObject("Scripting.FileSystemObject")
Set objFile = FSO.GetFile(Request.ServerVariables("APPL_PHYSICAL_PATH") & "main\manifests\close\results\archive\" & rsManifests.Fields("REPORT_CODE").value & ".pdf")
log.log "File Object Size: " & objFile.Size
log.log "Error Number: " & Err.Number
If objFile.Size > 2000 Then
If Err.Number <> 0 Then
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="red" face="Tahoma"><B>[<%=Err.Source%>][<%=Err.Number%>][<%=Err.Description%>]</B></font><BR>';
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1" color="darkred" face="Tahoma"><B>Error printing manifest.  This manifest can be reprinted from the Reprint area of the Manifests menu.</B></font><BR><BR>';
</script>
<%
Response.Flush
Else
If strTemplateCode = "USPS" Then
If Instr(strUSPSReports,rsManifests.Fields("REPORT_FILE").value) Then
%>
<script language="javascript">
try
{
document.all.PfastshipEliteTools.PrintURL("https://<%=Request.ServerVariables("HTTP_HOST")%>/main/manifests/close/results/archive/<%=rsManifests.Fields("REPORT_CODE").value%>.pdf");
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<a href="archive/<%=rsManifests.Fields("REPORT_CODE").value%>.pdf" target="_new"><B><font size="1" color="blue" face="Tahoma" style="cursor=hand;">Click here to view this manifest</B></font></a><BR><BR>';
}
catch(e)
{
}
</script>
<%
End If
Else

log.log "Report Code " & rsManifests.Fields("REPORT_CODE").value
%>
<script language="javascript">
try
{
document.all.PfastshipEliteTools.PrintURL("https://<%=Request.ServerVariables("HTTP_HOST")%>/main/manifests/close/results/archive/<%=rsManifests.Fields("REPORT_CODE").value%>.pdf");
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<a href="archive/<%=rsManifests.Fields("REPORT_CODE").value%>.pdf" target="_new"><B><font size="1" color="blue" face="Tahoma" style="cursor=hand;">Click here to view this manifest</B></font></a><BR><BR>';
}
catch(e)
{
}
</script>
<%
Response.Flush
End If
End If
Else
%>
<script language="javascript">
document.all.statusdiv.innerHTML =  document.all.statusdiv.innerHTML +'<font size="1"color="darkred" face="Tahoma"><B>Report empty, nothing will print for this report.</B></font><BR><BR>';
</script>
<%
Response.Flush
End If
Response.Flush()
End If
On Error Goto 0

rsManifests.MoveNext
Loop
End If
Next
Close(objConn)
%>
<script language="javascript" defer>
// JES 01/08/2009 - This resets the variable so that if the close is finished, and the user closes the popup it
// will not pop up the warning message defined at the top of this page
blStillClosing = false;
document.all.statusimg.src='../../../images/scan-stopped.gif';
document.all.headertitle.innerText = 'Process complete.';
document.all.headerfooter.innerText = 'Your manifests have been closed.  Click the Close button to dismiss this dialog.';
document.all.btnClose.disabled = false;
window.dialogArguments.parent.middle_right.btnCloseManifests.disabled = false;
window.dialogArguments.parent.middle_left.location.reload();
</script>
</html>
